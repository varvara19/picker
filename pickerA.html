<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Google Picker – Drive.file demo</title>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: -apple-system, system-ui, sans-serif;
        background: #f9fafb;
      }
      #root {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #card {
        max-width: 380px;
        width: 100%;
        border-radius: 18px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 20px 60px rgba(0,0,0,0.12);
        padding: 24px 20px;
        background: #fff;
        text-align: center;
      }
      #card h2 {
        margin: 0 0 10px;
        font-size: 18px;
        font-weight: 600;
      }
      #card p {
        margin: 0 0 18px;
        font-size: 14px;
        color: #6b7280;
      }
      #connect-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 9px 16px;
        border-radius: 999px;
        border: none;
        background: #1d4ed8;
        color: #fff;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
      }
      #status {
        margin-top: 10px;
        font-size: 12px;
        color: #9ca3af;
      }
    </style>

    <!-- gapi + GIS -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <div id="root">
      <div id="card">
        <h2>Connect Google Drive</h2>
        <p>Sign in and pick your Google Forms.</p>
        <button id="connect-btn" type="button">Continue with Google</button>
        <div id="status">Waiting for Google libraries…</div>
      </div>
    </div>

    <script>
      // ---- минимальный логгер (как в треде) ----
      function debug(step, message, extra) {
        console.log(`[${step}]`, message, extra || "");
      }

      window.onerror = function(message, source, lineno, colno, error) {
        debug("window.onerror", message, { source, lineno, colno, error: String(error) });
      };

      window.addEventListener("unhandledrejection", function(event) {
        debug("unhandledrejection", String(event.reason || ""), null);
      });

      // ---- читаем конфиг из query params ----
      const params = new URLSearchParams(window.location.search);
      const CONFIG = {
        clientId: params.get("client_id") || "",
        apiKey: params.get("api_key") || "",
        locale: params.get("locale") || "en",
      };

      const statusEl = document.getElementById("status");
      const connectBtn = document.getElementById("connect-btn");

      function setStatus(text) {
        if (statusEl) statusEl.textContent = text;
        debug("status", text, null);
      }

      let tokenClient = null;
      let accessToken = null;
      let pickerReady = false;

      function initTokenClient() {
        if (!CONFIG.clientId) {
          setStatus("Missing client_id in URL");
          debug("config-error", "client_id is missing", CONFIG);
          return;
        }

        const scope = "https://www.googleapis.com/auth/drive.file";

        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CONFIG.clientId,
          scope,
          callback: (response) => {
            if (response.error) {
              setStatus("Authorization error");
              debug("gis-error", String(response.error), response);
              return;
            }
            accessToken = response.access_token;
            setStatus("Authorized. Loading Picker…");
            debug("gis-token", "access token ok", null);
            maybeOpenPicker();
          },
        });

        setStatus("Google Sign-In ready");
        debug("gis-ready", "token client initialized", null);
      }

      function loadPickerModule() {
        if (!window.gapi) {
          setStatus("gapi not loaded");
          debug("gapi-error", "gapi undefined", null);
          return;
        }

        gapi.load("picker", {
          callback: () => {
            pickerReady = true;
            setStatus("Picker API loaded");
            debug("picker-api", "Picker API loaded", null);
            maybeOpenPicker();
          },
        });
      }

      function maybeOpenPicker() {
        if (!pickerReady || !accessToken) return;

        if (!CONFIG.apiKey) {
          setStatus("Missing api_key in URL");
          debug("config-error", "api_key is missing", CONFIG);
          return;
        }

        try {
          const view = new google.picker.DocsView(google.picker.ViewId.DOCS)
            .setMimeTypes("application/vnd.google-apps.form")
            .setIncludeFolders(false)
            .setMode(google.picker.DocsViewMode.LIST);

          const picker = new google.picker.PickerBuilder()
            .setDeveloperKey(CONFIG.apiKey)
            .setOAuthToken(accessToken)
            .setLocale(CONFIG.locale)
            .addView(view)
            .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
            .setCallback((data) => {
              const action = data[google.picker.Response.ACTION];
              if (action === google.picker.Action.PICKED) {
                const docs = data[google.picker.Response.DOCUMENTS] || [];
                debug("picked", "docs", docs);
              } else if (action === google.picker.Action.CANCEL) {
                debug("cancel", "picker cancelled", null);
              }
            })
            .build();

          picker.setVisible(true);
          setStatus("Picker visible");
          debug("picker-visible", "Picker shown", null);
        } catch (e) {
          setStatus("Error creating Picker");
          debug("picker-error", String(e), null);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        debug("dom-loaded", "DOM loaded", CONFIG);
        setStatus("DOM loaded, waiting for Google libraries…");

        // ждём gapi
        const gapiInterval = setInterval(() => {
          if (window.gapi) {
            clearInterval(gapiInterval);
            debug("gapi", "gapi loaded", null);
            loadPickerModule();
          }
        }, 50);

        // ждём GIS
        const gisInterval = setInterval(() => {
          if (window.google && google.accounts && google.accounts.oauth2) {
            clearInterval(gisInterval);
            initTokenClient();
          }
        }, 50);

        connectBtn.addEventListener("click", () => {
          if (!tokenClient) {
            setStatus("Google Sign-In not ready yet");
            debug("gis-not-ready", "tokenClient is null", null);
            return;
          }
          setStatus("Waiting for Google authorization…");
          debug("gis-request", "requestAccessToken", null);
          tokenClient.requestAccessToken({ prompt: "consent" });
        });
      });
    </script>
  </body>
</html>
