<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Google Picker – Token</title>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #f9fafb;
        font-family: -apple-system, system-ui, sans-serif;
      }
      #root {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #card {
        max-width: 380px;
        width: 100%;
        border-radius: 18px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 20px 60px rgba(0,0,0,0.12);
        padding: 24px 20px;
        background: #fff;
        text-align: center;
      }
      #card h2 {
        margin: 0 0 10px;
        font-size: 18px;
        font-weight: 600;
      }
      #card p {
        margin: 0 0 18px;
        font-size: 14px;
        color: #6b7280;
      }
      #status {
        margin-top: 10px;
        font-size: 12px;
        color: #9ca3af;
      }
    </style>

    <!-- только gapi, без GIS -->
    <script src="https://apis.google.com/js/api.js"></script>
  </head>
  <body>
    <div id="root">
      <div id="card">
        <h2>Google Forms Picker</h2>
        <p>Loading your forms…</p>
        <div id="status">Initializing…</div>
      </div>
    </div>

    <script>
      // простенький логгер
      function debug(step, message, extra) {
        console.log(`[${step}]`, message, extra || "");
      }

      window.onerror = function(message, source, lineno, colno, error) {
        debug("window.onerror", message, { source, lineno, colno, error: String(error) });
      };

      window.addEventListener("unhandledrejection", function(event) {
        debug("unhandledrejection", String(event.reason || ""), null);
      });

      const statusEl = document.getElementById("status");
      function setStatus(text) {
        if (statusEl) statusEl.textContent = text;
        debug("status", text, null);
      }

      // читаем apiKey и token из query
      const params = new URLSearchParams(window.location.search);
      const CONFIG = {
        apiKey: params.get("apiKey") || params.get("api_key") || "",
        accessToken: params.get("token") || params.get("access_token") || "",
        locale: params.get("locale") || "en",
      };

      if (!CONFIG.apiKey) {
        setStatus("Missing apiKey in URL");
        debug("config-error", "no apiKey", CONFIG);
      }
      if (!CONFIG.accessToken) {
        setStatus("Missing access token in URL");
        debug("config-error", "no accessToken", CONFIG);
      }

      let pickerReady = false;

      function loadPickerModule() {
        if (!window.gapi) {
          setStatus("gapi not loaded");
          debug("gapi-error", "gapi undefined", null);
          return;
        }

        gapi.load("picker", {
          callback: () => {
            pickerReady = true;
            setStatus("Picker API loaded");
            debug("picker-api", "Picker API loaded", null);
            maybeOpenPicker();
          },
        });
      }

      function maybeOpenPicker() {
        if (!pickerReady) return;
        if (!CONFIG.apiKey || !CONFIG.accessToken) return;

        try {
          const view = new google.picker.DocsView(google.picker.ViewId.DOCS)
            .setMimeTypes("application/vnd.google-apps.form")
            .setIncludeFolders(false)
            .setMode(google.picker.DocsViewMode.LIST);

          const picker = new google.picker.PickerBuilder()
            .setDeveloperKey(CONFIG.apiKey)
            .setOAuthToken(CONFIG.accessToken)
            .setLocale(CONFIG.locale)
            .addView(view)
            .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
            .setCallback((data) => {
              const action = data[google.picker.Response.ACTION];
              if (action === google.picker.Action.PICKED) {
                const docs = data[google.picker.Response.DOCUMENTS] || [];
                debug("picked", "docs", docs);
              } else if (action === google.picker.Action.CANCEL) {
                debug("cancel", "picker cancelled", null);
              }
            })
            .build();

          picker.setVisible(true);
          setStatus("Picker visible");
          debug("picker-visible", "Picker shown", null);
        } catch (e) {
          setStatus("Error creating Picker");
          debug("picker-error", String(e), null);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        debug("dom-loaded", "DOM loaded", CONFIG);
        setStatus("DOM loaded, loading gapi…");

        const interval = setInterval(() => {
          if (window.gapi) {
            clearInterval(interval);
            debug("gapi", "gapi loaded", null);
            loadPickerModule();
          }
        }, 50);
      });
    </script>
  </body>
</html>
